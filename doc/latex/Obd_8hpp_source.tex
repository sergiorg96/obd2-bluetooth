\hypertarget{Obd_8hpp_source}{}\section{Obd.\+hpp}
\label{Obd_8hpp_source}\index{Obd.\+hpp@{Obd.\+hpp}}

\begin{DoxyCode}
00001 
00008 \textcolor{preprocessor}{#ifndef OBD\_HPP}
00009 \textcolor{preprocessor}{#define OBD\_HPP}
00010 
00011 \textcolor{preprocessor}{#include <iostream>}
00012 \textcolor{preprocessor}{#include <fstream>}
00013 \textcolor{preprocessor}{#include <thread>}
00014 
00015 \textcolor{preprocessor}{#include <bitset>}
00016 \textcolor{preprocessor}{#include <vector>}
00017 \textcolor{preprocessor}{#include <sstream>}
00018 \textcolor{preprocessor}{#include <algorithm>}
00019 
00020 \textcolor{preprocessor}{#include <utility>}
00021 \textcolor{preprocessor}{#include <map>}
00022 
00023 \textcolor{preprocessor}{#include <typeinfo>}
00024 
00025 \textcolor{preprocessor}{#include <netinet/in.h>}
00026 \textcolor{preprocessor}{#include <arpa/inet.h>}
00027 \textcolor{preprocessor}{#include <sys/types.h>}
00028 \textcolor{preprocessor}{#include <sys/socket.h>}
00029 \textcolor{preprocessor}{#include <sys/epoll.h>}
00030 
00031 \textcolor{preprocessor}{#include <bluetooth/bluetooth.h>}
00032 \textcolor{preprocessor}{#include <bluetooth/rfcomm.h>}
00033 \textcolor{preprocessor}{#include <bluetooth/hci.h>}
00034 \textcolor{preprocessor}{#include <bluetooth/hci\_lib.h>}
00035 
00036 \textcolor{preprocessor}{#include <unistd.h>}
00037 
00038 \textcolor{preprocessor}{#include <ctime>}
00039 
00040 \textcolor{preprocessor}{#include "\hyperlink{Commands_8hpp}{Commands.hpp}"}
00041 \textcolor{preprocessor}{#include "\hyperlink{decoders_8hpp}{decoders.hpp}"}
00042 \textcolor{preprocessor}{#include "\hyperlink{loadcfg_8hpp}{loadcfg.hpp}"}
00043 \textcolor{preprocessor}{#include "\hyperlink{debug_8hpp}{debug.hpp}"}
00044 
00045 \textcolor{preprocessor}{#ifdef TEST}
00046 \textcolor{preprocessor}{    #define socket mock\_socket}
00047 \textcolor{preprocessor}{    #include "../test/MockSocket.cpp"}
00048 \textcolor{preprocessor}{#endif}
00049 
00050 
00051 
\Hypertarget{Obd_8hpp_source_l00052}\hyperlink{Obd_8hpp_a115fbf8b5fd0f0b7e912dd166068415b}{00052} \textcolor{preprocessor}{#define MAX\_EP\_EVTS 20 }
\Hypertarget{Obd_8hpp_source_l00058}\hyperlink{Obd_8hpp_ab701e3ac61a85b337ec5c1abaad6742d}{00058} \textcolor{preprocessor}{using json = nlohmann::json; }
00059 
\Hypertarget{Obd_8hpp_source_l00064}\hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{00064} \textcolor{keyword}{typedef} std::pair<std::string, Commands> \hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{tupla};
00065 
\Hypertarget{Obd_8hpp_source_l00073}\hyperlink{classObd}{00073} \textcolor{keyword}{class }\hyperlink{classObd}{Obd} \{
00074 \textcolor{keyword}{public}:
\Hypertarget{Obd_8hpp_source_l00075}\hyperlink{classObd_a8300062d1b651d049cf2a2bc916496cd}{00075}     std::map<std::string, Commands> \hyperlink{classObd_a8300062d1b651d049cf2a2bc916496cd}{map\_commands}; 
\Hypertarget{Obd_8hpp_source_l00083}\hyperlink{classObd_abd8375cee2ad218a9ae8b464d7b1d63f}{00083}     \hyperlink{classObd_abd8375cee2ad218a9ae8b464d7b1d63f}{Obd}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *deviceName)\{
00084         \textcolor{comment}{// Comenzamos el descubrimiento del dipositivo Bluetooth}
00085         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Iniciando descubrimiento del dispositivo %s"}, deviceName);
00086         this->\hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{discoverDeviceAddress}(deviceName, this->dest);
00087         \textcolor{keywordflow}{if}(this->m\_deviceFound)\{
00088             \textcolor{comment}{// Si lo encontramos nos conectamos}
00089             this->\hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{connectBluetooth}();
00090             \textcolor{keywordflow}{if} (this->m\_status)\{
00091                 \textcolor{comment}{// Si la conexión tiene éxito, iniciamos los decodificadores}
00092                 this->\hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{initDecoderFunctions}();
00093                 \textcolor{comment}{// Leemos el archivo de PIDS}
00094                 this->\hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{readFileData}();
00095                 \textcolor{comment}{// Comenzamos el envío de mensajes de inicio}
00096                 this->\hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{initMessages}();
00097             \}
00098         \} \textcolor{keywordflow}{else} \{
00099             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Dispositivo %s no encontrado."}, deviceName);
00100         \}
00101     \}
00102 
\Hypertarget{Obd_8hpp_source_l00112}\hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{00112}     \textcolor{keywordtype}{void} \hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{discoverDeviceAddress}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} * deviceName, \textcolor{keywordtype}{char} *deviceAddress)\{
00113         inquiry\_info *ii = NULL;
00114         \textcolor{keywordtype}{int} max\_rsp, num\_rsp;
00115         \textcolor{keywordtype}{int} dev\_id, sock, len, flags;
00116         \textcolor{keywordtype}{int} i;
00117         \textcolor{keywordtype}{char} addr[19] = \{ 0 \};
00118         \textcolor{keywordtype}{char} name[248] = \{ 0 \};
00119 
00120         \textcolor{comment}{//Identificamos la interfaz bluetooth del dispositivo}
00121         dev\_id = hci\_get\_route(NULL);
00122         \textcolor{comment}{//Abrimos socket para esta interfaz}
00123         sock = hci\_open\_dev( dev\_id );
00124         \textcolor{keywordflow}{if} (dev\_id < 0 || sock < 0) \{
00125             perror(\textcolor{stringliteral}{"Abriendo socket"});
00126             exit(1);
00127         \}
00128 
00129         len  = 8;
00130         max\_rsp = 255;
00131         flags = IREQ\_CACHE\_FLUSH;
00132         ii = (inquiry\_info*)malloc(max\_rsp * \textcolor{keyword}{sizeof}(inquiry\_info));
00133 
00134         \textcolor{comment}{//Iniciamos el descubrimiento de dispositivos bluetooth}
00135         num\_rsp = hci\_inquiry(dev\_id, len, max\_rsp, NULL, &ii, flags);
00136         \textcolor{keywordflow}{if}( num\_rsp < 0 ) perror(\textcolor{stringliteral}{"hci\_inquiry"});
00137 
00138         \textcolor{comment}{//Entre todas las respuestas buscamos el dispositivo bluetooth de OBDII}
00139         \textcolor{keywordflow}{for} (i = 0; i < num\_rsp; i++) \{
00140             ba2str(&(ii+i)->bdaddr, addr);
00141             memset(name, 0, \textcolor{keyword}{sizeof}(name));
00142             \textcolor{keywordflow}{if} (hci\_read\_remote\_name(sock, &(ii+i)->bdaddr, \textcolor{keyword}{sizeof}(name), name, 0) < 0)
00143                 strcpy(name, \textcolor{stringliteral}{"[unknown]"});
00144             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s  %s"}, addr, name);
00145             \textcolor{comment}{//Si la cadena introducida a la función es igual al dispositivo encontrado guardamos la
       dirección}
00146             \textcolor{keywordflow}{if}(strcmp(deviceName, name) == 0)\{
00147                 this->m\_deviceFound = \textcolor{keyword}{true};
00148                 strcpy(deviceAddress, addr);
00149                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Dispositivo %s encontrado"}, deviceName);
00150                 \textcolor{keywordflow}{break};
00151             \}
00152         \}
00153 
00154         free( ii );
00155         close( sock );
00156     \}   
00157 
\Hypertarget{Obd_8hpp_source_l00167}\hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{00167}     \textcolor{keywordtype}{void} \hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{connectBluetooth}()\{
00168         \textcolor{keywordflow}{try}\{
00169             \textcolor{keyword}{struct }sockaddr\_rc addr;
00170             \textcolor{keywordtype}{int} statusConnection;
00171 
00172             \textcolor{comment}{// Abrimos socket bluetooh}
00173             this->m\_cli\_s = socket(AF\_BLUETOOTH, SOCK\_STREAM, BTPROTO\_RFCOMM);
00174 
00175             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"socket: %d"}, this->m\_cli\_s);
00176             \textcolor{keywordflow}{if} (this->m\_cli\_s < 0) \{
00177                 \textcolor{keywordflow}{throw} std::string(\textcolor{stringliteral}{"error abriendo socket BT/RFCOMM"});
00178             \}
00179 
00180             addr.rc\_family = AF\_BLUETOOTH;
00181             str2ba(this->dest, &addr.rc\_bdaddr );
00182             addr.rc\_channel = (uint8\_t) 1;
00183 
00184             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Conectando con %s (canal %d)"}, this->dest, addr.rc\_channel);
00185             \textcolor{comment}{//Iniciamos la conexión}
00186             statusConnection = connect(this->m\_cli\_s, (\textcolor{keyword}{struct} sockaddr *)&addr, \textcolor{keyword}{sizeof}(addr));
00187 
00188             \textcolor{keywordflow}{if} (statusConnection) \{
00189                 close(this->m\_cli\_s);
00190                 \textcolor{keywordflow}{throw} std::string(\textcolor{stringliteral}{"No se ha podido conectar"});
00191             \}
00192 
00193             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Conectado!"});
00194             this->m\_status = \textcolor{keyword}{true};
00195 
00196             \textcolor{comment}{//Creamos instancia epoll para la recepción de datos en el socket}
00197             this->epoll\_fd = epoll\_create(1);
00198             \textcolor{keywordflow}{if} (this->epoll\_fd < 0) \{
00199                 perror(\textcolor{stringliteral}{"No se ha podido crear epoll"});
00200                 close(this->m\_cli\_s);
00201             \}
00202 
00203             this->ev.events = EPOLLIN;
00204             this->ev.data.fd = this->m\_cli\_s;
00205 
00206             \textcolor{comment}{//Añadimos el socket de conexión a la instancia de epoll creada}
00207             \textcolor{keywordtype}{int} err = epoll\_ctl(this->epoll\_fd, EPOLL\_CTL\_ADD, this->m\_cli\_s, &ev);
00208             
00209             \textcolor{keywordflow}{if} (err) \{
00210                 perror(\textcolor{stringliteral}{"No se ha podido añadir el socket cliente a la instancia epoll"});
00211                 close(this->m\_cli\_s);
00212                 close(this->epoll\_fd);
00213             \}
00214 
00215 
00216         \} \textcolor{keywordflow}{catch}(std::string e) \{
00217             std::cerr << e << std::endl;
00218         \}
00219     \}
00220 
\Hypertarget{Obd_8hpp_source_l00228}\hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{00228}     \textcolor{keywordtype}{void} \hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{readFileData}()\{
00229         std::ifstream ifs(\textcolor{stringliteral}{"data/PIDS.json"});
00230         \textcolor{keyword}{auto} j = json::parse(ifs);
00231 
00232         \textcolor{comment}{//Convertimos todos los PIDS en objetos del tipo Commands y los añadimos a Obd}
00233         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < (int)j.size(); ++i)
00234         \{
00235             this->map\_commands.insert(\hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{tupla}(j[i][\textcolor{stringliteral}{"name"}], \hyperlink{classCommands}{Commands}(j[i])));
00236         \}
00237     \}
00238     
\Hypertarget{Obd_8hpp_source_l00248}\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{00248}     \textcolor{keywordtype}{void} \hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(\hyperlink{classCommands}{Commands} command)\{
00249         \textcolor{comment}{//Iniciamos en un hilo de ejecución la función polling de recepción de datos}
00250         std::thread t1(&\hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{Obd::polling}, \textcolor{keyword}{this}, command);
00251 
00252         \textcolor{keywordtype}{char} *p;
00253         \textcolor{keywordtype}{char} buf[1024];
00254         \textcolor{keywordtype}{int} len;
00255 
00256         \textcolor{comment}{//Comando a enviar}
00257         std::string message = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}();
00258         strcpy(buf, message.c\_str());
00259 
00260         len = strlen(buf);
00261         buf[len] = \textcolor{charliteral}{'\(\backslash\)n'};
00262         buf[len+1] = \textcolor{charliteral}{'\(\backslash\)0'};
00263         
00264         \textcolor{comment}{// Todo los mensajes a ELM327  deben terminar con el caracter retorno de carro (hex  ‘0D’, \(\backslash\)r).}
00265         p = buf;
00266         \textcolor{keywordflow}{while} (*p) \{
00267             \textcolor{keywordflow}{if} (*p == \textcolor{charliteral}{'\(\backslash\)n'})
00268                 *p = \textcolor{charliteral}{'\(\backslash\)r'};
00269             p++;
00270         \}
00271         
00272         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje a enviar: %s"}, buf);
00273         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Enviando mensaje..."});
00274         write(this->m\_cli\_s, buf, strlen(buf));
00275         
00276         \textcolor{comment}{//Queda a la espera de finalización de ejecución del hilo de recepción del mensaje OBD}
00277         t1.join();
00278     \}
00279 
\Hypertarget{Obd_8hpp_source_l00292}\hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{00292}     \textcolor{keywordtype}{void} \hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{polling}(\hyperlink{classCommands}{Commands} command)\{
00293         \textcolor{keyword}{struct }epoll\_event events[MAX\_EP\_EVTS];
00294         \textcolor{keywordtype}{int} nfds;
00295         \textcolor{keywordtype}{bool} continuar = \textcolor{keyword}{true};
00296 
00297         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Polling function"});
00298 
00299         \textcolor{comment}{// Bucle infinito para el envío de datos por bluetooth al conector OBD}
00300         \textcolor{keywordflow}{while}(continuar) \{
00301         \textcolor{comment}{// Buffer para enviar y recibir}
00302             \textcolor{keywordtype}{char} message\_rcv[1024], buf[1024], *p;
00303             ssize\_t len;
00304             \textcolor{keywordtype}{int} i;
00305             \textcolor{comment}{//Quedamos a la espera de recepción de eventos en la instancia epoll (socket)}
00306             nfds = epoll\_wait(this->epoll\_fd, events, MAX\_EP\_EVTS, -1);
00307             \textcolor{keywordflow}{if} (nfds < 0) \{
00308                 perror(\textcolor{stringliteral}{"epoll error"});
00309                 \textcolor{keywordflow}{break};
00310             \}
00311             \textcolor{keywordflow}{for} (i = 0; i < nfds; i++) \{
00312                 \textcolor{keywordflow}{if} ((events[i].events & EPOLLERR) || (events[i].events & EPOLLHUP)) \{
00313                     \hyperlink{debug_8hpp_a06cd512b8b15b6da31a5a557445f7027}{debugError}(\textcolor{stringliteral}{"epoll error"});
00314                 \}
00315                 \textcolor{comment}{//Si los eventos detectados corresponden al socket de conexión con el vehículo, tratamos el
       mensaje}
00316                 \textcolor{keywordflow}{if} (events[i].data.fd == this->m\_cli\_s) \{
00317                     len = read(this->m\_cli\_s, &buf, \textcolor{keyword}{sizeof}(buf) - 1);
00318                     \textcolor{keywordflow}{if} (len < 0) \{
00319                         perror(\textcolor{stringliteral}{"socket read error"});
00320                         \textcolor{keywordflow}{continue};
00321                     \}
00322                     \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Evento leído: %s"}, buf);
00323                     strcat(message\_rcv, buf);
00324                     \textcolor{comment}{//Si se detecta el caracter ">" se ha finalizado el mensaje}
00325                     \textcolor{keywordflow}{if}(strstr(buf, \textcolor{stringliteral}{">"}) != NULL) \{
00326                         len = strlen(message\_rcv);
00327                         message\_rcv[len] = \textcolor{charliteral}{'\(\backslash\)0'};
00328 
00329                         p = message\_rcv;
00330                         \textcolor{comment}{//Conversión inversa del mensaje ELM327 enviado en el último carácter}
00331                         \textcolor{keywordflow}{while}(*p) \{
00332                             \textcolor{keywordflow}{if} (*p == \textcolor{charliteral}{'\(\backslash\)r'})
00333                                 *p = \textcolor{charliteral}{'\(\backslash\)n'};
00334                             p++;
00335                         \}
00336                         \textcolor{comment}{//Transformar respuesta}
00337                         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje recibido:\(\backslash\)n%s"}, message\_rcv);
00338 
00339                         \textcolor{keywordtype}{char} * ocurrencia = message\_rcv;
00340                         \textcolor{keywordflow}{if}((ocurrencia=strstr(ocurrencia, command.\hyperlink{classCommands_ab4806a2fda5c80e10ab4446faa1e39b5}{getCMDResponse}().c\_str())) 
      != NULL)\{
00341                             \textcolor{keywordflow}{while}((ocurrencia=strstr(ocurrencia, command.
      \hyperlink{classCommands_ab4806a2fda5c80e10ab4446faa1e39b5}{getCMDResponse}().c\_str())) != NULL)\{
00342                                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Ocurrencia encontrada"});
00343                                 \textcolor{keywordtype}{char} info[1024];
00344                                 memset(info, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(info));
00345                                 strncpy(info, ocurrencia + command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}().size() , command.
      \hyperlink{classCommands_a9b3d961dbebbd25f141d18cd5a267738}{getBytesResponse}());
00346                                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Información: %s"}, info);
00347                                 std::string type\_data = command.\hyperlink{classCommands_a7d983e153465d335db0b3ad7724b8ef6}{getTypeData}();
00348                                 \textcolor{comment}{//Dependiendo del tipo de dato de la respuesta se busca el decodificador
       correspondiente}
00349                                 \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"float"}))\{
00350                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsFloat[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00351                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00352                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado << \textcolor{stringliteral}{" "}<< command.
      \hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00353                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00354                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!type\_data.compare(\textcolor{stringliteral}{"OxigenoResponse"}))\{
00355                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStructOx[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00356                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00357                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado.A << \textcolor{stringliteral}{"/"} << varResultado.B << \textcolor{stringliteral}{" "}<< 
      command.\hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00358                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00359 
00360                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"RelacionesResponse"})) \{
00361                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStructRel[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00362                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00363                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado.A << \textcolor{stringliteral}{"/"} << varResultado.B << \textcolor{stringliteral}{"/"} <<
       varResultado.C << \textcolor{stringliteral}{"/"} << varResultado.D << \textcolor{stringliteral}{" "}<< command.\hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00364                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00365 
00366                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!type\_data.compare(\textcolor{stringliteral}{"vectorInt"}))\{
00367                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsVectorInt[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00368                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00369 
00370                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00371                                     \textcolor{comment}{//Tratamiento para los PIDs disponibles}
00372                                     \textcolor{keywordflow}{for} (uint32\_t i = 0; i < varResultado.size(); ++i)\{
00373                                         std::string substr\_cmd = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}().substr(2,2);
00374                                         \textcolor{keywordtype}{int} sum\_pid = stoi(substr\_cmd,\textcolor{keyword}{nullptr},16);
00375                                         std::stringstream stream;
00376                                         stream << std::hex << sum\_pid+varResultado[i];
00377                                         std::string result(stream.str());
00378                                         \textcolor{keywordflow}{if}(result.size() == 1)
00379                                         \textcolor{comment}{//Si el resultado solo tiene un caracter se añade un 0 al principio}
00380                                             result.insert(0,\textcolor{stringliteral}{"0"});
00381                                         result.insert(0,\textcolor{stringliteral}{"01"});
00382                                         std::transform(result.begin(), result.end(),result.begin(), 
      ::toupper);
00383 
00384                                         \textcolor{comment}{//Almacenamos el resultado de los PIDs disponibles}
00385                                         this->vecPIDs.push\_back(result);
00386                                     \}
00387                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"vectorStr"})) \{
00388                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsVectorStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00389                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00390                                     \textcolor{comment}{//Decodificador para DTC}
00391                                     \textcolor{keywordflow}{if} (varResultado.empty())\{
00392                                         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"No hay DTC en el vehículo"});
00393                                     \} \textcolor{keywordflow}{else} \{
00394                                         this->vecDTCs = varResultado;
00395                                         \textcolor{keywordflow}{for} (uint32\_t i = 0; i < varResultado.size(); ++i)
00396                                         \{
00397                                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Enviar DTC: %s"}, varResultado[i].c\_str());
00398                                         \}
00399                                     \}
00400                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"string"})) \{
00401                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00402                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00403                                     \textcolor{comment}{//Decodificador para el número de identificación del vehículo}
00404                                     \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().compare(\textcolor{stringliteral}{"decodeVIN"}))
00405                                         this->vin.append(varResultado);
00406                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00407                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"map"})) \{
00408                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsMap[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00409                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00410                                     this->mapStatus = varResultado;
00411                                 \} \textcolor{keywordflow}{else} \{
00412                                     \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Tipo de dato no reconocido"});
00413                                 \}
00414                                 ocurrencia++;
00415                             \}
00416                             std::cout << \textcolor{stringliteral}{"--------------------------------------------------------------"} <
      < std::endl;
00417                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));
00418                             continuar = \textcolor{keyword}{false};
00419                             \textcolor{comment}{//Respuestas de mensajes de AT de configuración}
00420                         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((strstr(message\_rcv, \textcolor{stringliteral}{"OK"})) != NULL)\{
00421                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s = OK."}, command.\hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}().c\_str());
00422                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00423                             continuar = \textcolor{keyword}{false};
00424                             \textcolor{comment}{//Vehículo sin el dato solicitado}
00425                         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((strstr(message\_rcv, \textcolor{stringliteral}{"NO DATA"})) != NULL)\{
00426                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s = No disponible."}, command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}().c\_str());
00427                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00428                             continuar = \textcolor{keyword}{false};
00429                         \} \textcolor{keywordflow}{else} \{
00430                             \textcolor{comment}{//Para conocer el protocolo actual}
00431                             \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}().compare(\textcolor{stringliteral}{"DESCRIBE\_PROTOCOL"}))\{
00432                                 \textcolor{keywordtype}{char} info[1024];
00433                                 \textcolor{keywordtype}{char}* token = strtok(message\_rcv, \textcolor{stringliteral}{"\(\backslash\)n"});
00434                                 strcpy(info, token);
00435                                 \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00436                                 this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00437                                 this->currentProtocol = varResultado;
00438                             \}\textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}().compare(\textcolor{stringliteral}{"DESCRIBE\_PROTOCOL\_NUMBER"}))\{
00439                                 \textcolor{keywordtype}{char} info[1024];
00440                                 \textcolor{keywordtype}{char}* token = strtok(message\_rcv, \textcolor{stringliteral}{"\(\backslash\)n"});
00441                                 strcpy(info, token);
00442                                 \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00443                                 this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00444                                 this->currentProtocolNumber = varResultado;
00445                             \} \textcolor{keywordflow}{else} \{
00446                                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje recibido no entendido!"});
00447                             \}
00448                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00449                             continuar = \textcolor{keyword}{false};
00450                         \}
00451                     \}
00452 
00453                     memset(buf, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(buf));
00454                 \} \textcolor{keywordflow}{else} \{
00455                     \hyperlink{debug_8hpp_a06cd512b8b15b6da31a5a557445f7027}{debugError}(\textcolor{stringliteral}{"Evento desconocido"});
00456                 \}
00457             \}
00458         \}
00459     \}
00460 
\Hypertarget{Obd_8hpp_source_l00472}\hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{00472}     \textcolor{keywordtype}{void} \hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{initMessages}()\{
00473         \textcolor{comment}{//Inicialización de la conexión con ELM327}
00474         std::map<std::string, std::string> listPIDs = \{
00475             \{\textcolor{stringliteral}{"PIDS\_B"}, \textcolor{stringliteral}{"0120"}\},
00476             \{\textcolor{stringliteral}{"PIDS\_C"}, \textcolor{stringliteral}{"0140"}\},
00477             \{\textcolor{stringliteral}{"PIDS\_D"}, \textcolor{stringliteral}{"0160"}\},
00478             \{\textcolor{stringliteral}{"PIDS\_E"}, \textcolor{stringliteral}{"0180"}\},
00479             \{\textcolor{stringliteral}{"PIDS\_F"}, \textcolor{stringliteral}{"01A0"}\},
00480             \{\textcolor{stringliteral}{"PIDS\_G"}, \textcolor{stringliteral}{"01C0"}\}
00481         \};
00482         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"RESET"})->second);
00483         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"DEFAULT\_VALUES"})->second);
00484         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"RESP\_SIN\_ESPACIOS"})->second);                   
00485         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"SIN\_ECO"})->second);
00486         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"SIN\_HEADER"})->second);                  
00487         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"AUTO\_PROTO"})->second);
00488         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"STATUS"})->second);
00489         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"GET\_VIN"})->second);
00490         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"PIDS\_A"})->second);
00491         \textcolor{comment}{//Bucle para detectar PIDs disponibles}
00492         \textcolor{keywordflow}{for} (std::map<std::string, std::string>::iterator it=listPIDs.begin(); it!=listPIDs.end(); ++it)\{
00493             \textcolor{keywordflow}{if}(this->\hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{existPID}(it->second))\{
00494                 this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(it->first)->second); 
00495             \}
00496         \}
00497         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Nº de comandos disponibles = %zu"}, vecPIDs.size());
00498     \}
00499 
\Hypertarget{Obd_8hpp_source_l00507}\hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{00507}     \textcolor{keywordtype}{void} \hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{initDecoderFunctions}()\{
00508     \textcolor{comment}{//Inicia las funciones dependiendo del tipo de dato de respuesta    }
00509     this->decoderFunctionsFloat = \{
00510             \{ \textcolor{stringliteral}{"decodeCargaPosicionEGR"}, \hyperlink{decoders_8cpp_adbe68794075963c37e654d53b8a46f68}{decodeCargaPosicionEGR}\},
00511             \{ \textcolor{stringliteral}{"decodeTempGeneral"}, \hyperlink{decoders_8cpp_af581438645d7ff67766fa2e5eba5eaf9}{decodeTempGeneral}\},
00512             \{ \textcolor{stringliteral}{"decodeAjusteCombustibleEGR"}, \hyperlink{decoders_8cpp_aeee9e6d8511a934b3a3644b19de3f2b7}{decodeAjusteCombustibleEGR}\},
00513             \{ \textcolor{stringliteral}{"decodePresionCombustible"}, \hyperlink{decoders_8cpp_ab1c03e72734d4127a1c48f3b5a44a2e2}{decodePresionCombustible}\},
00514             \{ \textcolor{stringliteral}{"decodeHexToDec"}, \hyperlink{decoders_8cpp_aa7c5243702d5462e4b638450e750624e}{decodeHexToDec}\},
00515             \{ \textcolor{stringliteral}{"decodeRPM"}, \hyperlink{decoders_8cpp_a889868c7b1e554aee496e6aed7101cc4}{decodeRPM}\},
00516             \{ \textcolor{stringliteral}{"decodeAvanceTiempo"}, \hyperlink{decoders_8cpp_a7a2fee87eace8ad6c86c628f5f91b3b5}{decodeAvanceTiempo}\},
00517             \{ \textcolor{stringliteral}{"decodeVelocidadMAF"}, \hyperlink{decoders_8cpp_adceefeb78a70b295b378f4c472630aa1}{decodeVelocidadMAF}\},
00518             \{ \textcolor{stringliteral}{"decodePresionCombColector"}, \hyperlink{decoders_8cpp_a3e32aaf8ced989570e141f01210564f3}{decodePresionCombColector}\},
00519             \{ \textcolor{stringliteral}{"decodePresionMedidorCombustible"}, \hyperlink{decoders_8cpp_a228605d8cad0901a691ba4155a2326fc}{decodePresionMedidorCombustible}
      \},
00520             \{ \textcolor{stringliteral}{"decodePresionVapor"}, \hyperlink{decoders_8cpp_ab86bda1fcefda784e048796e2d892475}{decodePresionVapor}\},
00521             \{ \textcolor{stringliteral}{"decodeTempCatalizador"}, \hyperlink{decoders_8cpp_a8251853ca2e5b8b2e88c75f50d53bc8d}{decodeTempCatalizador}\},
00522             \{ \textcolor{stringliteral}{"decodeVoltajeControl"}, \hyperlink{decoders_8cpp_a5937fc059394faad8c9c96a0b27a8796}{decodeVoltajeControl}\},
00523             \{ \textcolor{stringliteral}{"decodeRelacionCombAireBasica"}, \hyperlink{decoders_8cpp_ade77bb9f8d8a2ba3aa431cdf9bdd0c32}{decodeRelacionCombAireBasica}\}
00524         \};
00525         this->decoderFunctionsStructOx = \{
00526             \{ \textcolor{stringliteral}{"decodeSensorOxigeno"}, \hyperlink{decoders_8cpp_a5b53fc5fc37fbee9c5e389f6c8c18438}{decodeSensorOxigeno}\},
00527             \{ \textcolor{stringliteral}{"decodeRelacionCombAire"}, \hyperlink{decoders_8cpp_a363bd4f505969098be58a175f02b9b50}{decodeRelacionCombAire}\},
00528             \{ \textcolor{stringliteral}{"decodeRelacionCombAireActual"}, \hyperlink{decoders_8cpp_a4cedb500095b25b3d4fff382094b0eb9}{decodeRelacionCombAireActual}\}
00529         \};
00530 
00531         this->decoderFunctionsStructRel[\textcolor{stringliteral}{"decodeRelaciones"}] = \hyperlink{decoders_8cpp_a88d7079325bf81705583d9f2101cfa15}{decodeRelaciones};
00532         this->decoderFunctionsVectorInt[\textcolor{stringliteral}{"decodePIDS"}] = \hyperlink{decoders_8cpp_aef44cca306ed9c74b146d2b7dd058763}{decodePIDS};
00533         this->decoderFunctionsVectorStr[\textcolor{stringliteral}{"decodeDTCs"}] = \hyperlink{decoders_8cpp_aac9b3d4ea17ee4dbbdf755b0b510137a}{decodeDTCs};
00534         this->decoderFunctionsStr = \{
00535             \{\textcolor{stringliteral}{"decodeVIN"}, \hyperlink{decoders_8cpp_a66754738119854c13a74265e209083e4}{decodeVIN}\},
00536             \{\textcolor{stringliteral}{"decodeDescribeProtocol"}, \hyperlink{decoders_8cpp_ab83ce79cd098ea655f3812488e304a0c}{decodeDescribeProtocol}\}
00537         \};
00538         this->decoderFunctionsMap[\textcolor{stringliteral}{"decodeStatus"}] = \hyperlink{decoders_8cpp_aca9cad863d8603615597a0291804c8ae}{decodeStatus};
00539         this->noDecodeFunctionAT[\textcolor{stringliteral}{"noDecodeAT"}] = \hyperlink{decoders_8cpp_a8ee851a37675f190ea728d6b2f0cdc92}{noDecodeAT};
00540     \}
00541 
\Hypertarget{Obd_8hpp_source_l00548}\hyperlink{classObd_a95d02f8f3c48557c5ad799ecb6dd7f79}{00548}     \textcolor{keywordtype}{void} \hyperlink{classObd_a95d02f8f3c48557c5ad799ecb6dd7f79}{disconnectBluetooth}()\{
00549         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Desconectando dispositivo Bluetooth"});
00550         close(this->m\_cli\_s);
00551         close(this->epoll\_fd);
00552     \}
00553 
\Hypertarget{Obd_8hpp_source_l00560}\hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{00560}     \textcolor{keywordtype}{bool} \hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{existPID}(std::string command)\{
00561         \textcolor{keywordtype}{bool} exists = \textcolor{keyword}{false};
00562         \textcolor{comment}{//Comprueba en la lista de PIDs que el comando este implementado}
00563         \textcolor{keywordflow}{for} (uint32\_t i = 0; i < this->vecPIDs.size(); ++i)\{
00564             \textcolor{keywordflow}{if}(!this->vecPIDs[i].compare(command))\{
00565                 exists = \textcolor{keyword}{true};
00566                 \textcolor{keywordflow}{break};
00567             \}
00568         \}
00569         \textcolor{keywordflow}{return} exists;
00570     \}
00571     
\Hypertarget{Obd_8hpp_source_l00579}\hyperlink{classObd_abf7e84f45236ea1c78c762ac895c532c}{00579}     \textcolor{keywordtype}{void} \hyperlink{classObd_abf7e84f45236ea1c78c762ac895c532c}{printPIDs}()\{
00580         \textcolor{comment}{//Iteración para imprimir por consola los PIDs disponibles}
00581         \textcolor{keywordflow}{for} (std::map<std::string, Commands>::iterator it=this->map\_commands.begin(); it!=this->
      map\_commands.end(); ++it)\{
00582             \hyperlink{classCommands}{Commands} command = it->second;
00583             std::string str\_cmd = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}();
00584             \textcolor{keywordflow}{for} (uint32\_t i = 0; i < this->vecPIDs.size(); ++i)\{
00585                 \textcolor{keywordflow}{if}(!str\_cmd.compare(this->vecPIDs[i]))\{
00586                     std::cout << str\_cmd << \textcolor{stringliteral}{" - "}<< command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00587                     \textcolor{keywordflow}{break};
00588                 \}
00589             \}
00590         \}
00591     \}
00592 
\Hypertarget{Obd_8hpp_source_l00599}\hyperlink{classObd_a0938bfdd6d05795e826a239cc0f29f32}{00599}     \textcolor{keywordtype}{void} \hyperlink{classObd_a0938bfdd6d05795e826a239cc0f29f32}{printStatus}()\{
00600         \textcolor{comment}{//Imprime por consola los resultados de las pruebas del comando STATUS}
00601         \textcolor{keywordflow}{for} (std::map<std::string, std::string>::iterator it=this->mapStatus.begin(); it!=this->mapStatus.
      end(); ++it)\{
00602             std::cout << it->first << \textcolor{stringliteral}{" -> "} << it->second << std::endl;
00603         \}
00604     \}
00605 
\Hypertarget{Obd_8hpp_source_l00611}\hyperlink{classObd_ad88a0f25a7e3961726737915668ee13d}{00611}     std::string \hyperlink{classObd_ad88a0f25a7e3961726737915668ee13d}{getVIN}()\{
00612         \textcolor{comment}{//Devuelve el número de identificación del vehículo}
00613         \textcolor{keywordflow}{return} this->vin;
00614     \}
00615     
\Hypertarget{Obd_8hpp_source_l00624}\hyperlink{classObd_ac57afb9228d933c6be5b2fa8e6446036}{00624}     std::vector<std::string> \hyperlink{classObd_ac57afb9228d933c6be5b2fa8e6446036}{getDTCs}()\{
00625         time\_t curr\_time;
00626         tm *curr\_tm;
00627         \textcolor{keywordtype}{char} date\_string[100];
00628         \textcolor{keywordtype}{char} time\_string[100];
00629         time(&curr\_time);
00630 
00631         curr\_tm = localtime(&curr\_time);
00632         strftime(date\_string, 50, \textcolor{stringliteral}{"%d/%m/%Y"}, curr\_tm);
00633         strftime(time\_string, 50, \textcolor{stringliteral}{"%T"}, curr\_tm);
00634         std::cout << date\_string << \textcolor{stringliteral}{" "} << time\_string << std::endl;
00635 
00636         \textcolor{comment}{//Consulta de DTC del vehículo}
00637         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"STATUS"})->second);
00638         \textcolor{keywordflow}{if} (this->mapStatus[\textcolor{stringliteral}{"DTC\_CNT"}].compare(\textcolor{stringliteral}{"0"}))\{
00639             this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"GET\_DTC"})->second);
00640         \} \textcolor{keywordflow}{else} \{
00641             std::cout << \textcolor{stringliteral}{"No hay DTC disponibles"} << std::endl;
00642         \}
00643         \textcolor{keywordflow}{return} this->vecDTCs;
00644     \}
00645 
\Hypertarget{Obd_8hpp_source_l00651}\hyperlink{classObd_ae28b765bb787467f929eae932133d2aa}{00651}     \textcolor{keywordtype}{bool} \hyperlink{classObd_ae28b765bb787467f929eae932133d2aa}{isValid}()\{
00652         \textcolor{comment}{//Bool del estado de la conexión bluetooth}
00653         \textcolor{keywordflow}{return} this->m\_status;
00654     \}
00655 \textcolor{keyword}{private}:
00656     \textcolor{comment}{// Atributos privados de la clase "Obd"}
00657     std::vector<std::string> vecPIDs; 
00658     std::vector<std::string> vecDTCs; 
00659     std::string vin; 
00660     std::string currentProtocol; 
00661     std::string currentProtocolNumber; 
00662     std::map<std::string, std::string> mapStatus; 
00664     std::map<std::string, std::function<void()>> noDecodeFunctionAT; 
00665     std::map<std::string, std::function<float(char *)>> decoderFunctionsFloat; 
00666     std::map<std::string, std::function<struct OxigenoResponse(char *)>> decoderFunctionsStructOx; 
00667     std::map<std::string, std::function<struct RelacionesResponse(char *)>> decoderFunctionsStructRel; 
00668     std::map<std::string, std::function<std::vector<int>(\textcolor{keywordtype}{char} *)>> decoderFunctionsVectorInt; 
00669     std::map<std::string, std::function<std::vector<std::string>(\textcolor{keywordtype}{char} *)>> decoderFunctionsVectorStr; 
00670     std::map<std::string, std::function<std::string(char *)>> decoderFunctionsStr; 
00671     std::map<std::string, std::function<std::map<std::string, std::string>(\textcolor{keywordtype}{char} *)>> decoderFunctionsMap; 
00673     \textcolor{keywordtype}{char} dest[19] = \{ 0 \}; 
00674     \textcolor{keywordtype}{int} m\_cli\_s; 
00675     \textcolor{keywordtype}{bool} m\_deviceFound = \textcolor{keyword}{false}; 
00676     \textcolor{keywordtype}{bool} m\_status = \textcolor{keyword}{false}; 
00677     \textcolor{keywordtype}{int} epoll\_fd; 
00678     \textcolor{keyword}{struct }epoll\_event ev; 
00679 \};
00680 
00681 
00682 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
