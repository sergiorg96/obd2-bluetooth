\hypertarget{Obd_8hpp_source}{}\section{Obd.\+hpp}
\label{Obd_8hpp_source}\index{Obd.\+hpp@{Obd.\+hpp}}

\begin{DoxyCode}
00001 
00008 \textcolor{preprocessor}{#ifndef OBD\_HPP}
00009 \textcolor{preprocessor}{#define OBD\_HPP}
00010 
00011 \textcolor{preprocessor}{#include <iostream>}
00012 \textcolor{preprocessor}{#include <fstream>}
00013 \textcolor{preprocessor}{#include <thread>}
00014 
00015 \textcolor{preprocessor}{#include <bitset>}
00016 \textcolor{preprocessor}{#include <vector>}
00017 \textcolor{preprocessor}{#include <sstream>}
00018 \textcolor{preprocessor}{#include <algorithm>}
00019 
00020 \textcolor{preprocessor}{#include <utility>}
00021 \textcolor{preprocessor}{#include <map>}
00022 
00023 \textcolor{preprocessor}{#include <typeinfo>}
00024 
00025 \textcolor{preprocessor}{#include <netinet/in.h>}
00026 \textcolor{preprocessor}{#include <arpa/inet.h>}
00027 \textcolor{preprocessor}{#include <sys/types.h>}
00028 \textcolor{preprocessor}{#include <sys/socket.h>}
00029 \textcolor{preprocessor}{#include <sys/epoll.h>}
00030 
00031 \textcolor{preprocessor}{#include <bluetooth/bluetooth.h>}
00032 \textcolor{preprocessor}{#include <bluetooth/rfcomm.h>}
00033 \textcolor{preprocessor}{#include <bluetooth/hci.h>}
00034 \textcolor{preprocessor}{#include <bluetooth/hci\_lib.h>}
00035 
00036 \textcolor{preprocessor}{#include <unistd.h>}
00037 
00038 \textcolor{preprocessor}{#include <ctime>}
00039 
00040 \textcolor{preprocessor}{#include "\hyperlink{Commands_8hpp}{Commands.hpp}"}
00041 \textcolor{preprocessor}{#include "\hyperlink{decoders_8hpp}{decoders.hpp}"}
00042 \textcolor{preprocessor}{#include "\hyperlink{loadcfg_8hpp}{loadcfg.hpp}"}
00043 \textcolor{preprocessor}{#include "\hyperlink{debug_8hpp}{debug.hpp}"}
00044 
00045 \textcolor{preprocessor}{#ifdef TEST}
00046 \textcolor{preprocessor}{    #define socket mock\_socket}
00047 \textcolor{preprocessor}{    #include "../test/MockSocket.cpp"}
00048 \textcolor{preprocessor}{#endif}
00049 
00050 
00051 
\Hypertarget{Obd_8hpp_source_l00052}\hyperlink{Obd_8hpp_a115fbf8b5fd0f0b7e912dd166068415b}{00052} \textcolor{preprocessor}{#define MAX\_EP\_EVTS 20 }
\Hypertarget{Obd_8hpp_source_l00058}\hyperlink{Obd_8hpp_ab701e3ac61a85b337ec5c1abaad6742d}{00058} \textcolor{preprocessor}{using json = nlohmann::json; }
00059 
\Hypertarget{Obd_8hpp_source_l00064}\hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{00064} \textcolor{keyword}{typedef} std::pair<std::string, Commands> \hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{tupla};
00065 
\Hypertarget{Obd_8hpp_source_l00073}\hyperlink{classObd}{00073} \textcolor{keyword}{class }\hyperlink{classObd}{Obd} \{
00074 \textcolor{keyword}{public}:
\Hypertarget{Obd_8hpp_source_l00075}\hyperlink{classObd_a8300062d1b651d049cf2a2bc916496cd}{00075}     std::map<std::string, Commands> \hyperlink{classObd_a8300062d1b651d049cf2a2bc916496cd}{map\_commands}; 
\Hypertarget{Obd_8hpp_source_l00083}\hyperlink{classObd_abd8375cee2ad218a9ae8b464d7b1d63f}{00083}     \hyperlink{classObd_abd8375cee2ad218a9ae8b464d7b1d63f}{Obd}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *deviceName)\{
00084         \textcolor{comment}{// Comenzamos el descubrimiento del dipositivo Bluetooth}
00085         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Iniciando descubrimiento del dispositivo %s"}, deviceName);
00086         this->\hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{discoverDeviceAddress}(deviceName, this->dest);
00087         \textcolor{keywordflow}{if}(this->m\_deviceFound)\{
00088             \textcolor{comment}{// Si lo encontramos nos conectamos}
00089             this->\hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{connectBluetooth}();
00090             \textcolor{keywordflow}{if} (this->m\_status)\{
00091                 \textcolor{comment}{// Si la conexión tiene éxito, iniciamos los decodificadores}
00092                 this->\hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{initDecoderFunctions}();
00093                 \textcolor{comment}{// Leemos el archivo de PIDS}
00094                 this->\hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{readFileData}();
00095                 \textcolor{comment}{// Comenzamos el envío de mensajes de inicio}
00096                 this->\hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{initMessages}();
00097             \}
00098         \} \textcolor{keywordflow}{else} \{
00099             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Dispositivo %s no encontrado."}, deviceName);
00100         \}
00101     \}
00102 
\Hypertarget{Obd_8hpp_source_l00112}\hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{00112}     \textcolor{keywordtype}{void} \hyperlink{classObd_a59676f3fa1fd3052216b55be0a79c474}{discoverDeviceAddress}(\textcolor{keyword}{const} \textcolor{keywordtype}{char} * deviceName, \textcolor{keywordtype}{char} *deviceAddress)\{
00113         inquiry\_info *ii = NULL;
00114         \textcolor{keywordtype}{int} max\_rsp, num\_rsp;
00115         \textcolor{keywordtype}{int} dev\_id, sock, len, flags;
00116         \textcolor{keywordtype}{int} i;
00117         \textcolor{keywordtype}{char} addr[19] = \{ 0 \};
00118         \textcolor{keywordtype}{char} name[248] = \{ 0 \};
00119 
00120         \textcolor{comment}{//Identificamos la interfaz bluetooth del dispositivo}
00121         dev\_id = hci\_get\_route(NULL);
00122         \textcolor{comment}{//Abrimos socket para esta interfaz}
00123         sock = hci\_open\_dev( dev\_id );
00124         \textcolor{keywordflow}{if} (dev\_id < 0 || sock < 0) \{
00125             perror(\textcolor{stringliteral}{"Abriendo socket"});
00126             exit(1);
00127         \}
00128 
00129         len  = 8;
00130         max\_rsp = 255;
00131         flags = IREQ\_CACHE\_FLUSH;
00132         ii = (inquiry\_info*)malloc(max\_rsp * \textcolor{keyword}{sizeof}(inquiry\_info));
00133 
00134         \textcolor{comment}{//Iniciamos el descubrimiento de dispositivos bluetooth}
00135         num\_rsp = hci\_inquiry(dev\_id, len, max\_rsp, NULL, &ii, flags);
00136         \textcolor{keywordflow}{if}( num\_rsp < 0 ) perror(\textcolor{stringliteral}{"hci\_inquiry"});
00137 
00138         \textcolor{comment}{//Entre todas las respuestas buscamos el dispositivo bluetooth de OBDII}
00139         \textcolor{keywordflow}{for} (i = 0; i < num\_rsp; i++) \{
00140             ba2str(&(ii+i)->bdaddr, addr);
00141             memset(name, 0, \textcolor{keyword}{sizeof}(name));
00142             \textcolor{keywordflow}{if} (hci\_read\_remote\_name(sock, &(ii+i)->bdaddr, \textcolor{keyword}{sizeof}(name), name, 0) < 0)
00143                 strcpy(name, \textcolor{stringliteral}{"[unknown]"});
00144             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s  %s"}, addr, name);
00145             \textcolor{comment}{//Si la cadena introducida a la función es igual al dispositivo encontrado guardamos la
       dirección}
00146             \textcolor{keywordflow}{if}(strcmp(deviceName, name) == 0)\{
00147                 this->m\_deviceFound = \textcolor{keyword}{true};
00148                 strcpy(deviceAddress, addr);
00149                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Dispositivo %s encontrado"}, deviceName);
00150                 \textcolor{keywordflow}{break};
00151             \}
00152         \}
00153 
00154         free( ii );
00155         close( sock );
00156     \}   
00157 
\Hypertarget{Obd_8hpp_source_l00167}\hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{00167}     \textcolor{keywordtype}{void} \hyperlink{classObd_a104ccc3f2e0a4a103ae4cd1daa2f64d8}{connectBluetooth}()\{
00168         \textcolor{keywordflow}{try}\{
00169             \textcolor{keyword}{struct }sockaddr\_rc addr;
00170             \textcolor{keywordtype}{int} statusConnection;
00171 
00172             \textcolor{comment}{// Abrimos socket bluetooh}
00173             this->m\_cli\_s = socket(AF\_BLUETOOTH, SOCK\_STREAM, BTPROTO\_RFCOMM);
00174 
00175             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"socket: %d"}, this->m\_cli\_s);
00176             \textcolor{keywordflow}{if} (this->m\_cli\_s < 0) \{
00177                 \textcolor{keywordflow}{throw} std::string(\textcolor{stringliteral}{"error abriendo socket BT/RFCOMM"});
00178             \}
00179 
00180             addr.rc\_family = AF\_BLUETOOTH;
00181             str2ba(this->dest, &addr.rc\_bdaddr );
00182             addr.rc\_channel = (uint8\_t) 1;
00183 
00184             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Conectando con %s (canal %d)"}, this->dest, addr.rc\_channel);
00185             \textcolor{comment}{//Iniciamos la conexión}
00186             statusConnection = connect(this->m\_cli\_s, (\textcolor{keyword}{struct} sockaddr *)&addr, \textcolor{keyword}{sizeof}(addr));
00187 
00188             \textcolor{keywordflow}{if} (statusConnection) \{
00189                 close(this->m\_cli\_s);
00190                 perror(\textcolor{stringliteral}{"error"});
00191                 \textcolor{keywordflow}{throw} std::string(\textcolor{stringliteral}{"No se ha podido conectar"});
00192             \}
00193 
00194             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Conectado!"});
00195             this->m\_status = \textcolor{keyword}{true};
00196 
00197             \textcolor{comment}{//Creamos instancia epoll para la recepción de datos en el socket}
00198             this->epoll\_fd = epoll\_create(1);
00199             \textcolor{keywordflow}{if} (this->epoll\_fd < 0) \{
00200                 perror(\textcolor{stringliteral}{"No se ha podido crear epoll"});
00201                 close(this->m\_cli\_s);
00202             \}
00203 
00204             this->ev.events = EPOLLIN;
00205             this->ev.data.fd = this->m\_cli\_s;
00206 
00207             \textcolor{comment}{//Añadimos el socket de conexión a la instancia de epoll creada}
00208             \textcolor{keywordtype}{int} err = epoll\_ctl(this->epoll\_fd, EPOLL\_CTL\_ADD, this->m\_cli\_s, &ev);
00209             
00210             \textcolor{keywordflow}{if} (err) \{
00211                 perror(\textcolor{stringliteral}{"No se ha podido añadir el socket cliente a la instancia epoll"});
00212                 close(this->m\_cli\_s);
00213                 close(this->epoll\_fd);
00214             \}
00215 
00216 
00217         \} \textcolor{keywordflow}{catch}(std::string e) \{
00218             std::cerr << e << std::endl;
00219         \}
00220     \}
00221 
\Hypertarget{Obd_8hpp_source_l00229}\hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{00229}     \textcolor{keywordtype}{void} \hyperlink{classObd_a2b8bd75834351a2205d53aec8b3747be}{readFileData}()\{
00230         std::ifstream ifs(\textcolor{stringliteral}{"data/PIDS.json"});
00231         \textcolor{keyword}{auto} j = json::parse(ifs);
00232 
00233         \textcolor{comment}{//Convertimos todos los PIDS en objetos del tipo Commands y los añadimos a Obd}
00234         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < (int)j.size(); ++i)
00235         \{
00236             this->map\_commands.insert(\hyperlink{Obd_8hpp_aaa63a77fc61ef01154d73b6fac67f1af}{tupla}(j[i][\textcolor{stringliteral}{"name"}], \hyperlink{classCommands}{Commands}(j[i])));
00237         \}
00238     \}
00239     
\Hypertarget{Obd_8hpp_source_l00249}\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{00249}     \textcolor{keywordtype}{void} \hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(\hyperlink{classCommands}{Commands} command)\{
00250         \textcolor{comment}{//Iniciamos en un hilo de ejecución la función polling de recepción de datos}
00251         std::thread t1(&\hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{Obd::polling}, \textcolor{keyword}{this}, command);
00252 
00253         \textcolor{keywordtype}{char} *p;
00254         \textcolor{keywordtype}{char} buf[1024];
00255         \textcolor{keywordtype}{int} len;
00256 
00257         \textcolor{comment}{//Comando a enviar}
00258         std::string message = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}();
00259         strcpy(buf, message.c\_str());
00260 
00261         len = strlen(buf);
00262         buf[len] = \textcolor{charliteral}{'\(\backslash\)n'};
00263         buf[len+1] = \textcolor{charliteral}{'\(\backslash\)0'};
00264         
00265         \textcolor{comment}{// Todo los mensajes a ELM327  deben terminar con el caracter retorno de carro (hex  ‘0D’, \(\backslash\)r).}
00266         p = buf;
00267         \textcolor{keywordflow}{while} (*p) \{
00268             \textcolor{keywordflow}{if} (*p == \textcolor{charliteral}{'\(\backslash\)n'})
00269                 *p = \textcolor{charliteral}{'\(\backslash\)r'};
00270             p++;
00271         \}
00272         
00273         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje a enviar: %s"}, buf);
00274         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Enviando mensaje..."});
00275         \textcolor{keywordflow}{if}(write(this->m\_cli\_s, buf, strlen(buf)) != (ssize\_t) strlen(buf))\{
00276             \hyperlink{debug_8hpp_a06cd512b8b15b6da31a5a557445f7027}{debugError}(\textcolor{stringliteral}{"Error enviando mensaje."});
00277         \}
00278         
00279         \textcolor{comment}{//Queda a la espera de finalización de ejecución del hilo de recepción del mensaje OBD}
00280         t1.join();
00281     \}
00282 
\Hypertarget{Obd_8hpp_source_l00295}\hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{00295}     \textcolor{keywordtype}{void} \hyperlink{classObd_a0792ecb9247f32760269fdf64a178f8f}{polling}(\hyperlink{classCommands}{Commands} command)\{
00296         \textcolor{keyword}{struct }epoll\_event events[MAX\_EP\_EVTS];
00297         \textcolor{keywordtype}{int} nfds;
00298         \textcolor{keywordtype}{bool} continuar = \textcolor{keyword}{true};
00299 
00300         \textcolor{comment}{//debugLog("Polling function");}
00301 
00302         \textcolor{comment}{// Bucle infinito para el envío de datos por bluetooth al conector OBD}
00303         \textcolor{keywordflow}{while}(continuar) \{
00304         \textcolor{comment}{// Buffer para enviar y recibir}
00305             \textcolor{keywordtype}{char} message\_rcv[1024], buf[1024], *p;
00306             ssize\_t len;
00307             \textcolor{keywordtype}{int} i;
00308             \textcolor{comment}{//Quedamos a la espera de recepción de eventos en la instancia epoll (socket)}
00309             nfds = epoll\_wait(this->epoll\_fd, events, MAX\_EP\_EVTS, -1);
00310             \textcolor{keywordflow}{if} (nfds < 0) \{
00311                 perror(\textcolor{stringliteral}{"epoll error"});
00312                 \textcolor{keywordflow}{break};
00313             \}
00314             \textcolor{keywordflow}{for} (i = 0; i < nfds; i++) \{
00315                 \textcolor{keywordflow}{if} ((events[i].events & EPOLLERR) || (events[i].events & EPOLLHUP)) \{
00316                     \hyperlink{debug_8hpp_a06cd512b8b15b6da31a5a557445f7027}{debugError}(\textcolor{stringliteral}{"epoll error"});
00317                 \}
00318                 \textcolor{comment}{//Si los eventos detectados corresponden al socket de conexión con el vehículo, tratamos el
       mensaje}
00319                 \textcolor{keywordflow}{if} (events[i].data.fd == this->m\_cli\_s) \{
00320                     len = read(this->m\_cli\_s, &buf, \textcolor{keyword}{sizeof}(buf) - 1);
00321                     \textcolor{keywordflow}{if} (len < 0) \{
00322                         perror(\textcolor{stringliteral}{"socket read error"});
00323                         \textcolor{keywordflow}{continue};
00324                     \}
00325                     \textcolor{comment}{//debugLog("Evento leído: %s", buf);}
00326                     strcat(message\_rcv, buf);
00327                     \textcolor{comment}{//Si se detecta el caracter ">" se ha finalizado el mensaje}
00328                     \textcolor{keywordflow}{if}(strstr(buf, \textcolor{stringliteral}{">"}) != NULL) \{
00329                         len = strlen(message\_rcv);
00330                         message\_rcv[len] = \textcolor{charliteral}{'\(\backslash\)0'};
00331 
00332                         p = message\_rcv;
00333                         \textcolor{comment}{//Conversión inversa del mensaje ELM327 enviado en el último carácter}
00334                         \textcolor{keywordflow}{while}(*p) \{
00335                             \textcolor{keywordflow}{if} (*p == \textcolor{charliteral}{'\(\backslash\)r'})
00336                                 *p = \textcolor{charliteral}{'\(\backslash\)n'};
00337                             p++;
00338                         \}
00339                         \textcolor{comment}{//Transformar respuesta}
00340                         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje recibido:\(\backslash\)n%s"}, message\_rcv);
00341 
00342                         \textcolor{keywordtype}{char} * ocurrencia = message\_rcv;
00343                         \textcolor{keywordflow}{if}((ocurrencia=strstr(ocurrencia, command.\hyperlink{classCommands_ab4806a2fda5c80e10ab4446faa1e39b5}{getCMDResponse}().c\_str())) 
      != NULL)\{
00344                             \textcolor{keywordflow}{while}((ocurrencia=strstr(ocurrencia, command.
      \hyperlink{classCommands_ab4806a2fda5c80e10ab4446faa1e39b5}{getCMDResponse}().c\_str())) != NULL)\{
00345                                 \textcolor{comment}{//debugLog("Ocurrencia encontrada");}
00346                                 \textcolor{keywordtype}{char} info[1024];
00347                                 memset(info, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(info));
00348                                 strncpy(info, ocurrencia + command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}().size() , command.
      \hyperlink{classCommands_a9b3d961dbebbd25f141d18cd5a267738}{getBytesResponse}());
00349                                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Información: %s"}, info);
00350                                 std::string type\_data = command.\hyperlink{classCommands_a7d983e153465d335db0b3ad7724b8ef6}{getTypeData}();
00351                                 \textcolor{comment}{//Dependiendo del tipo de dato de la respuesta se busca el decodificador
       correspondiente}
00352                                 \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"float"}))\{
00353                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsFloat[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00354                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00355                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado << \textcolor{stringliteral}{" "}<< command.
      \hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00356                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00357                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!type\_data.compare(\textcolor{stringliteral}{"OxigenoResponse"}))\{
00358                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStructOx[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00359                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00360                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado.A << \textcolor{stringliteral}{"/"} << varResultado.B << \textcolor{stringliteral}{" "}<< 
      command.\hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00361                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00362 
00363                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"RelacionesResponse"})) \{
00364                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStructRel[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00365                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00366                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado.A << \textcolor{stringliteral}{"/"} << varResultado.B << \textcolor{stringliteral}{"/"} <<
       varResultado.C << \textcolor{stringliteral}{"/"} << varResultado.D << \textcolor{stringliteral}{" "}<< command.\hyperlink{classCommands_ac67214a4fbd93fbb4d8ebb2dd815a3fa}{getUnits}() << std::endl;
00367                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00368 
00369                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!type\_data.compare(\textcolor{stringliteral}{"vectorInt"}))\{
00370                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsVectorInt[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00371                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00372 
00373                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00374                                     \textcolor{comment}{//Tratamiento para los PIDs disponibles}
00375                                     \textcolor{keywordflow}{for} (uint32\_t i = 0; i < varResultado.size(); ++i)\{
00376                                         std::string substr\_cmd = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}().substr(2,2);
00377                                         \textcolor{keywordtype}{int} sum\_pid = stoi(substr\_cmd,\textcolor{keyword}{nullptr},16);
00378                                         std::stringstream stream;
00379                                         stream << std::hex << sum\_pid+varResultado[i];
00380                                         std::string result(stream.str());
00381                                         \textcolor{keywordflow}{if}(result.size() == 1)
00382                                         \textcolor{comment}{//Si el resultado solo tiene un caracter se añade un 0 al principio}
00383                                             result.insert(0,\textcolor{stringliteral}{"0"});
00384                                         result.insert(0,\textcolor{stringliteral}{"01"});
00385                                         std::transform(result.begin(), result.end(),result.begin(), 
      ::toupper);
00386 
00387                                         \textcolor{comment}{//Almacenamos el resultado de los PIDs disponibles}
00388                                         this->vecPIDs.push\_back(result);
00389                                     \}
00390                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"vectorStr"})) \{
00391                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsVectorStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00392                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00393                                     \textcolor{comment}{//Decodificador para DTC}
00394                                     \textcolor{keywordflow}{if} (varResultado.empty())\{
00395                                         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"No hay DTC en el vehículo"});
00396                                     \} \textcolor{keywordflow}{else} \{
00397                                         this->vecDTCs = varResultado;
00398                                         \textcolor{keywordflow}{for} (uint32\_t i = 0; i < varResultado.size(); ++i)
00399                                         \{
00400                                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Enviar DTC: %s"}, varResultado[i].c\_str());
00401                                         \}
00402                                     \}
00403                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"string"})) \{
00404                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00405                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00406                                     \textcolor{comment}{//Decodificador para el número de identificación del vehículo}
00407                                     \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().compare(\textcolor{stringliteral}{"decodeVIN"}))
00408                                         this->vin.append(varResultado);
00409                                     std::cout << command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00410                                     std::cout << \textcolor{stringliteral}{"-> "} << varResultado << std::endl;
00411                                 \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (!type\_data.compare(\textcolor{stringliteral}{"map"})) \{
00412                                     \textcolor{keyword}{auto} varResultado = this->decoderFunctionsMap[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00413                                     this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00414                                     this->mapStatus = varResultado;
00415                                 \} \textcolor{keywordflow}{else} \{
00416                                     \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Tipo de dato no reconocido"});
00417                                 \}
00418                                 ocurrencia++;
00419                             \}
00420                             std::cout << \textcolor{stringliteral}{"--------------------------------------------------------------"} <
      < std::endl;
00421                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));
00422                             continuar = \textcolor{keyword}{false};
00423                             \textcolor{comment}{//Respuestas de mensajes de AT de configuración}
00424                         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((strstr(message\_rcv, \textcolor{stringliteral}{"OK"})) != NULL)\{
00425                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s = OK."}, command.\hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}().c\_str());
00426                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00427                             continuar = \textcolor{keyword}{false};
00428                             \textcolor{comment}{//Vehículo sin el dato solicitado}
00429                         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((strstr(message\_rcv, \textcolor{stringliteral}{"NO DATA"})) != NULL)\{
00430                             \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"%s = No disponible."}, command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}().c\_str());
00431                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00432                             continuar = \textcolor{keyword}{false};
00433                         \} \textcolor{keywordflow}{else} \{
00434                             \textcolor{comment}{//Para conocer el protocolo actual}
00435                             \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}().compare(\textcolor{stringliteral}{"DESCRIBE\_PROTOCOL"}))\{
00436                                 \textcolor{keywordtype}{char} info[1024];
00437                                 \textcolor{keywordtype}{char}* token = strtok(message\_rcv, \textcolor{stringliteral}{"\(\backslash\)n"});
00438                                 strcpy(info, token);
00439                                 \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00440                                 this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00441                                 this->currentProtocol = varResultado;
00442                             \}\textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}().compare(\textcolor{stringliteral}{"DESCRIBE\_PROTOCOL\_NUMBER"}))\{
00443                                 \textcolor{keywordtype}{char} info[1024];
00444                                 \textcolor{keywordtype}{char}* token = strtok(message\_rcv, \textcolor{stringliteral}{"\(\backslash\)n"});
00445                                 strcpy(info, token);
00446                                 \textcolor{keyword}{auto} varResultado = this->decoderFunctionsStr[command.
      \hyperlink{classCommands_a8b4c2a655d8dd3de334338d6684d469c}{getDecoder}().c\_str()](info);
00447                                 this->map\_commands.find(command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}())->second.setResValue(
      varResultado);
00448                                 this->currentProtocolNumber = varResultado;
00449                             \} \textcolor{keywordflow}{else} \{
00450                                 \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Mensaje recibido no entendido!"});
00451                             \}
00452                             memset(message\_rcv, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(message\_rcv));                         
00453                             continuar = \textcolor{keyword}{false};
00454                         \}
00455                     \}
00456 
00457                     memset(buf, \textcolor{charliteral}{'\(\backslash\)0'}, \textcolor{keyword}{sizeof}(buf));
00458                 \} \textcolor{keywordflow}{else} \{
00459                     \hyperlink{debug_8hpp_a06cd512b8b15b6da31a5a557445f7027}{debugError}(\textcolor{stringliteral}{"Evento desconocido"});
00460                 \}
00461             \}
00462         \}
00463     \}
00464 
\Hypertarget{Obd_8hpp_source_l00476}\hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{00476}     \textcolor{keywordtype}{void} \hyperlink{classObd_a5091314ed8068800cce40e7a74a3731e}{initMessages}()\{
00477         \textcolor{comment}{//Inicialización de la conexión con ELM327}
00478         std::map<std::string, std::string> listPIDs = \{
00479             \{\textcolor{stringliteral}{"PIDS\_B"}, \textcolor{stringliteral}{"0120"}\},
00480             \{\textcolor{stringliteral}{"PIDS\_C"}, \textcolor{stringliteral}{"0140"}\},
00481             \{\textcolor{stringliteral}{"PIDS\_D"}, \textcolor{stringliteral}{"0160"}\},
00482             \{\textcolor{stringliteral}{"PIDS\_E"}, \textcolor{stringliteral}{"0180"}\},
00483             \{\textcolor{stringliteral}{"PIDS\_F"}, \textcolor{stringliteral}{"01A0"}\},
00484             \{\textcolor{stringliteral}{"PIDS\_G"}, \textcolor{stringliteral}{"01C0"}\}
00485         \};
00486         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"RESET"})->second);
00487         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"DEFAULT\_VALUES"})->second);
00488         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"RESP\_SIN\_ESPACIOS"})->second);                   
00489         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"SIN\_ECO"})->second);
00490         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"SIN\_HEADER"})->second);                  
00491         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"AUTO\_PROTO"})->second);
00492         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"STATUS"})->second);
00493         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"GET\_VIN"})->second);
00494         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"PIDS\_A"})->second);
00495         \textcolor{comment}{//Bucle para detectar PIDs disponibles}
00496         \textcolor{keywordflow}{for} (std::map<std::string, std::string>::iterator it=listPIDs.begin(); it!=listPIDs.end(); ++it)\{
00497             \textcolor{keywordflow}{if}(this->\hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{existPID}(it->second))\{
00498                 this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(it->first)->second); 
00499             \}
00500         \}
00501         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Nº de comandos disponibles = %zu"}, vecPIDs.size());
00502     \}
00503 
\Hypertarget{Obd_8hpp_source_l00511}\hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{00511}     \textcolor{keywordtype}{void} \hyperlink{classObd_a560631b2e3af0a72c063f915a11e0466}{initDecoderFunctions}()\{
00512     \textcolor{comment}{//Inicia las funciones dependiendo del tipo de dato de respuesta    }
00513     this->decoderFunctionsFloat = \{
00514             \{ \textcolor{stringliteral}{"decodeCargaPosicionEGR"}, \hyperlink{decoders_8cpp_adbe68794075963c37e654d53b8a46f68}{decodeCargaPosicionEGR}\},
00515             \{ \textcolor{stringliteral}{"decodeTempGeneral"}, \hyperlink{decoders_8cpp_af581438645d7ff67766fa2e5eba5eaf9}{decodeTempGeneral}\},
00516             \{ \textcolor{stringliteral}{"decodeAjusteCombustibleEGR"}, \hyperlink{decoders_8cpp_aeee9e6d8511a934b3a3644b19de3f2b7}{decodeAjusteCombustibleEGR}\},
00517             \{ \textcolor{stringliteral}{"decodePresionCombustible"}, \hyperlink{decoders_8cpp_ab1c03e72734d4127a1c48f3b5a44a2e2}{decodePresionCombustible}\},
00518             \{ \textcolor{stringliteral}{"decodeHexToDec"}, \hyperlink{decoders_8cpp_aa7c5243702d5462e4b638450e750624e}{decodeHexToDec}\},
00519             \{ \textcolor{stringliteral}{"decodeRPM"}, \hyperlink{decoders_8cpp_a889868c7b1e554aee496e6aed7101cc4}{decodeRPM}\},
00520             \{ \textcolor{stringliteral}{"decodeAvanceTiempo"}, \hyperlink{decoders_8cpp_a7a2fee87eace8ad6c86c628f5f91b3b5}{decodeAvanceTiempo}\},
00521             \{ \textcolor{stringliteral}{"decodeVelocidadMAF"}, \hyperlink{decoders_8cpp_adceefeb78a70b295b378f4c472630aa1}{decodeVelocidadMAF}\},
00522             \{ \textcolor{stringliteral}{"decodePresionCombColector"}, \hyperlink{decoders_8cpp_a3e32aaf8ced989570e141f01210564f3}{decodePresionCombColector}\},
00523             \{ \textcolor{stringliteral}{"decodePresionMedidorCombustible"}, \hyperlink{decoders_8cpp_a228605d8cad0901a691ba4155a2326fc}{decodePresionMedidorCombustible}
      \},
00524             \{ \textcolor{stringliteral}{"decodePresionVapor"}, \hyperlink{decoders_8cpp_ab86bda1fcefda784e048796e2d892475}{decodePresionVapor}\},
00525             \{ \textcolor{stringliteral}{"decodeTempCatalizador"}, \hyperlink{decoders_8cpp_a8251853ca2e5b8b2e88c75f50d53bc8d}{decodeTempCatalizador}\},
00526             \{ \textcolor{stringliteral}{"decodeVoltajeControl"}, \hyperlink{decoders_8cpp_a5937fc059394faad8c9c96a0b27a8796}{decodeVoltajeControl}\},
00527             \{ \textcolor{stringliteral}{"decodeRelacionCombAireBasica"}, \hyperlink{decoders_8cpp_ade77bb9f8d8a2ba3aa431cdf9bdd0c32}{decodeRelacionCombAireBasica}\}
00528         \};
00529         this->decoderFunctionsStructOx = \{
00530             \{ \textcolor{stringliteral}{"decodeSensorOxigeno"}, \hyperlink{decoders_8cpp_a5b53fc5fc37fbee9c5e389f6c8c18438}{decodeSensorOxigeno}\},
00531             \{ \textcolor{stringliteral}{"decodeRelacionCombAire"}, \hyperlink{decoders_8cpp_a363bd4f505969098be58a175f02b9b50}{decodeRelacionCombAire}\},
00532             \{ \textcolor{stringliteral}{"decodeRelacionCombAireActual"}, \hyperlink{decoders_8cpp_a4cedb500095b25b3d4fff382094b0eb9}{decodeRelacionCombAireActual}\}
00533         \};
00534 
00535         this->decoderFunctionsStructRel[\textcolor{stringliteral}{"decodeRelaciones"}] = \hyperlink{decoders_8cpp_a88d7079325bf81705583d9f2101cfa15}{decodeRelaciones};
00536         this->decoderFunctionsVectorInt[\textcolor{stringliteral}{"decodePIDS"}] = \hyperlink{decoders_8cpp_aef44cca306ed9c74b146d2b7dd058763}{decodePIDS};
00537         this->decoderFunctionsVectorStr[\textcolor{stringliteral}{"decodeDTCs"}] = \hyperlink{decoders_8cpp_aac9b3d4ea17ee4dbbdf755b0b510137a}{decodeDTCs};
00538         this->decoderFunctionsStr = \{
00539             \{\textcolor{stringliteral}{"decodeVIN"}, \hyperlink{decoders_8cpp_a66754738119854c13a74265e209083e4}{decodeVIN}\},
00540             \{\textcolor{stringliteral}{"decodeDescribeProtocol"}, \hyperlink{decoders_8cpp_ab83ce79cd098ea655f3812488e304a0c}{decodeDescribeProtocol}\}
00541         \};
00542         this->decoderFunctionsMap[\textcolor{stringliteral}{"decodeStatus"}] = \hyperlink{decoders_8cpp_aca9cad863d8603615597a0291804c8ae}{decodeStatus};
00543         this->noDecodeFunctionAT[\textcolor{stringliteral}{"noDecodeAT"}] = \hyperlink{decoders_8cpp_a8ee851a37675f190ea728d6b2f0cdc92}{noDecodeAT};
00544     \}
00545 
\Hypertarget{Obd_8hpp_source_l00552}\hyperlink{classObd_a95d02f8f3c48557c5ad799ecb6dd7f79}{00552}     \textcolor{keywordtype}{void} \hyperlink{classObd_a95d02f8f3c48557c5ad799ecb6dd7f79}{disconnectBluetooth}()\{
00553         \hyperlink{debug_8hpp_a55f41cf7b0585224496de3d7adbc101c}{debugLog}(\textcolor{stringliteral}{"Desconectando dispositivo Bluetooth"});
00554         close(this->m\_cli\_s);
00555         close(this->epoll\_fd);
00556     \}
00557 
\Hypertarget{Obd_8hpp_source_l00564}\hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{00564}     \textcolor{keywordtype}{bool} \hyperlink{classObd_aeff55ecb0a0a4278a22f20db3d2e17e3}{existPID}(std::string command)\{
00565         \textcolor{keywordtype}{bool} exists = \textcolor{keyword}{false};
00566         \textcolor{comment}{//Comprueba en la lista de PIDs que el comando este implementado}
00567         \textcolor{keywordflow}{for} (uint32\_t i = 0; i < this->vecPIDs.size(); ++i)\{
00568             \textcolor{keywordflow}{if}(!this->vecPIDs[i].compare(command))\{
00569                 exists = \textcolor{keyword}{true};
00570                 \textcolor{keywordflow}{break};
00571             \}
00572         \}
00573         \textcolor{keywordflow}{return} exists;
00574     \}
00575     
\Hypertarget{Obd_8hpp_source_l00583}\hyperlink{classObd_abf7e84f45236ea1c78c762ac895c532c}{00583}     \textcolor{keywordtype}{void} \hyperlink{classObd_abf7e84f45236ea1c78c762ac895c532c}{printPIDs}()\{
00584         \textcolor{comment}{//Iteración para imprimir por consola los PIDs disponibles}
00585         \textcolor{keywordflow}{for} (std::map<std::string, Commands>::iterator it=this->map\_commands.begin(); it!=this->
      map\_commands.end(); ++it)\{
00586             \hyperlink{classCommands}{Commands} command = it->second;
00587             std::string str\_cmd = command.\hyperlink{classCommands_a9aee21ab91fdfc8e9daa59e1e8f20b73}{getCMD}();
00588             \textcolor{keywordflow}{for} (uint32\_t i = 0; i < this->vecPIDs.size(); ++i)\{
00589                 \textcolor{keywordflow}{if}(!str\_cmd.compare(this->vecPIDs[i]))\{
00590                     std::cout << str\_cmd << \textcolor{stringliteral}{" - "}<< command.\hyperlink{classCommands_adf3d8a96310b1f4e57a6ecf0f2f153ea}{getName}() << \textcolor{stringliteral}{" - "} << command.
      \hyperlink{classCommands_ad82fe7dfcf1908423bdb59d048020e26}{getDescription}() << \textcolor{stringliteral}{" - Min="} << command.\hyperlink{classCommands_af0a1e2ea65b5a57997c721a8d77a1013}{getMIN}() << \textcolor{stringliteral}{" Max="} << command.
      \hyperlink{classCommands_afbad1051313d0cdecba276384cb7fc6b}{getMAX}() << std::endl;
00591                     \textcolor{keywordflow}{break};
00592                 \}
00593             \}
00594         \}
00595     \}
00596 
\Hypertarget{Obd_8hpp_source_l00603}\hyperlink{classObd_a0938bfdd6d05795e826a239cc0f29f32}{00603}     \textcolor{keywordtype}{void} \hyperlink{classObd_a0938bfdd6d05795e826a239cc0f29f32}{printStatus}()\{
00604         \textcolor{comment}{//Imprime por consola los resultados de las pruebas del comando STATUS}
00605         \textcolor{keywordflow}{for} (std::map<std::string, std::string>::iterator it=this->mapStatus.begin(); it!=this->mapStatus.
      end(); ++it)\{
00606             std::cout << it->first << \textcolor{stringliteral}{" -> "} << it->second << std::endl;
00607         \}
00608     \}
00609 
\Hypertarget{Obd_8hpp_source_l00615}\hyperlink{classObd_ad88a0f25a7e3961726737915668ee13d}{00615}     std::string \hyperlink{classObd_ad88a0f25a7e3961726737915668ee13d}{getVIN}()\{
00616         \textcolor{comment}{//Devuelve el número de identificación del vehículo}
00617         \textcolor{keywordflow}{return} this->vin;
00618     \}
00619     
\Hypertarget{Obd_8hpp_source_l00628}\hyperlink{classObd_ac57afb9228d933c6be5b2fa8e6446036}{00628}     std::vector<std::string> \hyperlink{classObd_ac57afb9228d933c6be5b2fa8e6446036}{getDTCs}()\{
00629         time\_t curr\_time;
00630         tm *curr\_tm;
00631         \textcolor{keywordtype}{char} date\_string[100];
00632         \textcolor{keywordtype}{char} time\_string[100];
00633         time(&curr\_time);
00634 
00635         curr\_tm = localtime(&curr\_time);
00636         strftime(date\_string, 50, \textcolor{stringliteral}{"%d/%m/%Y"}, curr\_tm);
00637         strftime(time\_string, 50, \textcolor{stringliteral}{"%T"}, curr\_tm);
00638         std::cout << date\_string << \textcolor{stringliteral}{" "} << time\_string << std::endl;
00639 
00640         \textcolor{comment}{//Consulta de DTC del vehículo}
00641         this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"STATUS"})->second);
00642         \textcolor{keywordflow}{if} (this->mapStatus[\textcolor{stringliteral}{"DTC\_CNT"}].compare(\textcolor{stringliteral}{"0"}))\{
00643             this->\hyperlink{classObd_a453591bc9a280e8d44d82025ce8590e9}{send}(this->map\_commands.find(\textcolor{stringliteral}{"GET\_DTC"})->second);
00644         \} \textcolor{keywordflow}{else} \{
00645             std::cout << \textcolor{stringliteral}{"No hay DTC disponibles"} << std::endl;
00646         \}
00647         \textcolor{keywordflow}{return} this->vecDTCs;
00648     \}
00649 
\Hypertarget{Obd_8hpp_source_l00655}\hyperlink{classObd_ae28b765bb787467f929eae932133d2aa}{00655}     \textcolor{keywordtype}{bool} \hyperlink{classObd_ae28b765bb787467f929eae932133d2aa}{isValid}()\{
00656         \textcolor{comment}{//Bool del estado de la conexión bluetooth}
00657         \textcolor{keywordflow}{return} this->m\_status;
00658     \}
00659 \textcolor{keyword}{private}:
00660     \textcolor{comment}{// Atributos privados de la clase "Obd"}
00661     std::vector<std::string> vecPIDs; 
00662     std::vector<std::string> vecDTCs; 
00663     std::string vin; 
00664     std::string currentProtocol; 
00665     std::string currentProtocolNumber; 
00666     std::map<std::string, std::string> mapStatus; 
00668     std::map<std::string, std::function<void()>> noDecodeFunctionAT; 
00669     std::map<std::string, std::function<float(char *)>> decoderFunctionsFloat; 
00670     std::map<std::string, std::function<struct OxigenoResponse(char *)>> decoderFunctionsStructOx; 
00671     std::map<std::string, std::function<struct RelacionesResponse(char *)>> decoderFunctionsStructRel; 
00672     std::map<std::string, std::function<std::vector<int>(\textcolor{keywordtype}{char} *)>> decoderFunctionsVectorInt; 
00673     std::map<std::string, std::function<std::vector<std::string>(\textcolor{keywordtype}{char} *)>> decoderFunctionsVectorStr; 
00674     std::map<std::string, std::function<std::string(char *)>> decoderFunctionsStr; 
00675     std::map<std::string, std::function<std::map<std::string, std::string>(\textcolor{keywordtype}{char} *)>> decoderFunctionsMap; 
00677     \textcolor{keywordtype}{char} dest[19] = \{ 0 \}; 
00678     \textcolor{keywordtype}{int} m\_cli\_s; 
00679     \textcolor{keywordtype}{bool} m\_deviceFound = \textcolor{keyword}{false}; 
00680     \textcolor{keywordtype}{bool} m\_status = \textcolor{keyword}{false}; 
00681     \textcolor{keywordtype}{int} epoll\_fd; 
00682     \textcolor{keyword}{struct }epoll\_event ev; 
00683 \};
00684 
00685 
00686 \textcolor{preprocessor}{#endif}
\end{DoxyCode}
